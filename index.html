<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presensi SMP Muhammadiyah 1 Kartasura</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        video { transform: scaleX(-1); }
        .btn-disabled { background-color: #cbd5e1 !important; color: #64748b !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        @keyframes pulse-red { 0%, 100% { background-color: rgba(220, 38, 38, 0.8); } 50% { background-color: rgba(220, 38, 38, 0.5); } }
        
        /* Custom Scrollbar for Modal */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden relative">

    <section id="page-login" class="h-full flex flex-col justify-center px-6 bg-white overflow-y-auto">
        <div class="mb-8 text-center mt-10">
            <img src="logo.png" class="h-24 mx-auto mb-4 object-contain" alt="Logo">
            <h1 class="text-2xl font-bold text-blue-900 leading-tight">SMP Muhammadiyah 1<br>Kartasura</h1>
            <p class="text-slate-500 font-medium">Sukoharjo</p>
            <div class="mt-2 w-16 h-1 bg-blue-600 mx-auto rounded-full"></div>
        </div>
        <form onsubmit="event.preventDefault(); doLogin();" class="space-y-4">
            <div><label class="block text-xs font-bold text-slate-400 mb-1 ml-1">EMAIL</label><input type="email" id="login-email" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-500 bg-slate-50" placeholder="nama@sekolah.id" required></div>
            <div><label class="block text-xs font-bold text-slate-400 mb-1 ml-1">PASSWORD</label><input type="password" id="login-pass" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-500 bg-slate-50" placeholder="******" required></div>
            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg active:scale-95 transition hover:bg-blue-700">Masuk Aplikasi</button>
        </form>
        
        <div class="mt-6">
            <button onclick="openInstallGuide()" class="w-full border border-blue-200 text-blue-600 font-bold py-3 rounded-lg hover:bg-blue-50 flex items-center justify-center gap-2">
                <i class="ph ph-download-simple text-lg"></i> Panduan Install Aplikasi
            </button>
        </div>

        <div class="mt-8 text-center border-t pt-6 mb-10"><p class="text-sm text-slate-400 mb-2">Guru / Karyawan Baru?</p><button onclick="switchPage('page-register')" class="text-blue-600 font-bold text-sm hover:underline flex items-center justify-center gap-1 w-full">Registrasi Akun <i class="ph ph-arrow-right"></i></button></div>
    </section>

    <section id="page-register" class="h-full flex flex-col justify-center px-6 bg-white hidden">
        <div class="mb-6 text-center">
            <img src="logo.png" class="h-12 mx-auto mb-2 opacity-80" alt="Logo Kecil">
            <h1 class="text-xl font-bold text-slate-800">Pendaftaran Akun</h1>
            <p class="text-xs text-slate-500">SMP Muhammadiyah 1 Kartasura</p>
        </div>
        <form onsubmit="event.preventDefault(); doRegister();" class="space-y-3">
            <div><label class="block text-xs font-bold text-slate-500 mb-1">Nama Lengkap & Gelar</label><input type="text" id="reg-nama" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Budi Santoso, S.Pd" required></div>
            <div><label class="block text-xs font-bold text-slate-500 mb-1">Jabatan / Posisi</label><input type="text" id="reg-jabatan" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Guru Matematika" required></div>
            <div><label class="block text-xs font-bold text-slate-500 mb-1">Email Sekolah / Pribadi</label><input type="email" id="reg-email" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-500" placeholder="email@contoh.com" required></div>
            <div><label class="block text-xs font-bold text-slate-500 mb-1">Password</label><input type="password" id="reg-pass" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-500" placeholder="Minimal 6 karakter" required></div>
            <button type="submit" class="w-full bg-slate-800 text-white font-bold py-3 rounded-lg mt-4 shadow-lg hover:bg-slate-900">Daftar Sekarang</button>
        </form>
        <div class="mt-6 text-center"><button onclick="switchPage('page-login')" class="text-sm text-blue-600 hover:underline">Kembali ke Login</button></div>
    </section>

    <section id="page-dashboard" class="h-full flex flex-col hidden relative">
        <div class="bg-blue-600 px-6 pt-8 pb-16 rounded-b-[2.5rem] shadow-lg text-white relative z-10">
            <div class="flex justify-between items-center mb-6 border-b border-blue-500 pb-4">
                <div class="flex items-center gap-3">
                    <img src="logo.png" class="h-10 w-10 bg-white rounded-full p-1 object-contain shadow-sm" alt="Logo">
                    <div><h1 class="font-bold text-white text-sm leading-tight">SMP Muhammadiyah 1 Kartasura</h1><p class="text-blue-200 text-xs">Sukoharjo</p></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openInstallGuide()" class="bg-blue-700 p-2 rounded-full hover:bg-blue-800 transition shadow border border-blue-500 text-blue-100" title="Panduan Install">
                        <i class="ph ph-download-simple text-lg"></i>
                    </button>
                    <button onclick="doLogout()" class="bg-red-500 p-2 rounded-full hover:bg-red-400 transition shadow text-white" title="Keluar">
                        <i class="ph ph-sign-out text-lg"></i>
                    </button>
                </div>
            </div>

            <div class="flex justify-between items-end mb-6">
                <div>
                    <p class="text-xs text-blue-200 mb-1">Selamat Datang,</p>
                    <h2 class="font-bold text-lg leading-tight" id="dash-nama">Loading...</h2>
                    <span class="text-[10px] bg-blue-700 px-2 py-0.5 rounded text-blue-100 mt-1 inline-block" id="dash-jabatan">...</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="openProfile()" class="bg-white p-2 rounded-full hover:bg-slate-100 transition shadow text-blue-600" title="Edit Profil"><i class="ph ph-user text-xl"></i></button>
                    <button onclick="openPasswordModal()" class="bg-amber-400 p-2 rounded-full hover:bg-amber-300 transition shadow text-white" title="Ganti Password"><i class="ph ph-lock-key text-xl"></i></button>
                </div>
            </div>
            
            <div id="loc-container" class="flex items-center gap-2 text-xs bg-blue-700/50 p-2 rounded-lg inline-flex backdrop-blur-sm border border-blue-500/30 transition-colors duration-300"><i id="loc-icon" class="ph ph-spinner animate-spin text-yellow-300"></i><span id="loc-status">Mencari Lokasi...</span></div>
        </div>

        <div class="px-6 -mt-10 pb-6 flex-1 overflow-y-auto space-y-4 z-20">
            <div class="flex gap-3">
                <div onclick="openHistory('MASUK')" class="flex-1 bg-white p-3 rounded-xl shadow-md border border-slate-100 text-center cursor-pointer active:scale-95 transition hover:bg-blue-50 group">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-1 group-hover:text-blue-500">Info Masuk</p>
                    <div id="box-masuk-val" class="text-sm font-bold text-slate-700">-</div>
                    <p class="text-[10px] text-blue-500 mt-1 underline">Lihat Detail</p>
                </div>
                <div onclick="openHistory('PULANG')" class="flex-1 bg-white p-3 rounded-xl shadow-md border border-slate-100 text-center cursor-pointer active:scale-95 transition hover:bg-blue-50 group">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-1 group-hover:text-blue-500">Info Pulang</p>
                    <div id="box-pulang-val" class="text-sm font-bold text-slate-700">-</div>
                    <p class="text-[10px] text-blue-500 mt-1 underline">Lihat Detail</p>
                </div>
            </div>

            <div class="text-center py-2"><h3 class="text-4xl font-mono font-bold text-slate-700 tracking-tight" id="dash-clock">00:00</h3><p class="text-xs text-slate-400 font-medium" id="dash-date">...</p></div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-2"><span class="font-bold text-slate-700">Presensi Masuk</span><span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">07:00 WIB</span></div>
                <button onclick="openCamera('MASUK')" id="btn-masuk" class="w-full bg-slate-300 text-slate-500 p-3 rounded-lg font-bold shadow flex justify-center items-center gap-2 cursor-not-allowed" disabled><i class="ph ph-spinner animate-spin"></i> Menunggu GPS...</button>
                <div id="info-masuk" class="hidden mt-2 text-xs text-center text-emerald-600 font-medium">Sudah absen pukul <span id="jam-absen-masuk"></span></div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-2"><span class="font-bold text-slate-700">Presensi Pulang</span><span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">14:00 WIB</span></div>
                <button onclick="openCamera('PULANG')" id="btn-pulang" class="w-full bg-slate-300 text-slate-500 p-3 rounded-lg font-bold shadow flex justify-center items-center gap-2 cursor-not-allowed" disabled><i class="ph ph-spinner animate-spin"></i> Menunggu GPS...</button>
            </div>
            <div class="text-center pb-4"><p class="text-[10px] text-slate-300">© SMP Muhammadiyah 1 Kartasura</p></div>
        </div>
    </section>

    <div id="install-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-0 flex flex-col max-h-[90vh] shadow-2xl animate-slide-up overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-blue-50">
                <h3 class="font-bold text-blue-900 flex items-center gap-2">
                    <i class="ph ph-download-simple text-xl"></i> Panduan Install
                </h3>
                <button onclick="document.getElementById('install-modal').classList.add('hidden')" class="p-1 rounded-full hover:bg-blue-100 text-slate-500"><i class="ph ph-x text-xl"></i></button>
            </div>
            
            <div class="p-5 overflow-y-auto custom-scroll space-y-6">
                
                <div>
                    <h4 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                        <i class="ph ph-android-logo text-green-600 text-lg"></i> Android (Chrome)
                    </h4>
                    <p class="text-xs text-slate-500 mb-2">Untuk HP Samsung, Xiaomi, Oppo, Vivo, dll.</p>
                    <ol class="list-decimal ml-5 text-sm text-slate-700 space-y-1">
                        <li>Buka aplikasi di <strong>Google Chrome</strong>.</li>
                        <li>Ketuk ikon <strong>Titik Tiga</strong> <i class="ph ph-dots-three-vertical inline bg-gray-200 rounded p-0.5"></i> di pojok kanan atas.</li>
                        <li>Pilih menu <strong>"Tambahkan ke Layar Utama"</strong> atau <em>"Install App"</em>.</li>
                        <li>Ketuk <strong>Install / Tambahkan</strong> pada pop-up yang muncul.</li>
                        <li>Aplikasi akan muncul di halaman depan HP Anda.</li>
                    </ol>
                </div>

                <hr class="border-slate-100">

                <div>
                    <h4 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                        <i class="ph ph-apple-logo text-gray-800 text-lg"></i> iOS (iPhone/iPad)
                    </h4>
                    <p class="text-xs text-slate-500 mb-2">Hanya bisa dilakukan lewat browser <strong>Safari</strong>.</p>
                    <ol class="list-decimal ml-5 text-sm text-slate-700 space-y-1">
                        <li>Buka aplikasi di <strong>Safari</strong>.</li>
                        <li>Ketuk tombol <strong>Share</strong> <i class="ph ph-export inline bg-gray-200 rounded p-0.5"></i> di bagian tengah bawah.</li>
                        <li>Geser ke bawah dan pilih <strong>"Add to Home Screen"</strong> (Tambah ke Layar Utama).</li>
                        <li>Ketuk <strong>Add</strong> di pojok kanan atas.</li>
                    </ol>
                </div>

                <hr class="border-slate-100">

                <div>
                    <h4 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                        <span class="bg-blue-600 text-white text-[10px] px-1 rounded">S</span> Samsung Internet
                    </h4>
                    <ol class="list-decimal ml-5 text-sm text-slate-700 space-y-1">
                        <li>Ketuk ikon <strong>Garis Tiga</strong> <i class="ph ph-list inline bg-gray-200 rounded p-0.5"></i> di kanan bawah.</li>
                        <li>Pilih menu <strong>"Add page to"</strong>.</li>
                        <li>Pilih <strong>"Home screen"</strong>.</li>
                    </ol>
                </div>
            </div>
            
            <div class="p-4 bg-gray-50 border-t text-center">
                <button onclick="document.getElementById('install-modal').classList.add('hidden')" class="bg-blue-600 text-white w-full py-2 rounded-lg font-bold shadow hover:bg-blue-700">Saya Mengerti</button>
            </div>
        </div>
    </div>

    <section id="page-profile" class="h-full flex flex-col hidden bg-gray-50 overflow-y-auto pb-10">
        <div class="bg-white px-6 pt-6 pb-4 shadow-sm sticky top-0 z-30">
            <div class="flex items-center gap-3"><button onclick="switchPage('page-dashboard')" class="text-slate-500 hover:text-blue-600"><i class="ph ph-arrow-left text-xl"></i></button><h1 class="text-lg font-bold text-slate-800">Profil Pengguna</h1></div>
        </div>
        <div class="p-6 space-y-6">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                <h2 class="font-bold text-blue-600 mb-4 flex items-center gap-2"><i class="ph ph-identification-card text-xl"></i> Data Pribadi</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div><label class="text-[10px] uppercase font-bold text-slate-400">Nama Lengkap</label><input type="text" id="prof-nama" class="w-full border-b py-1 focus:outline-none focus:border-blue-500 text-sm font-medium"></div>
                    <div><label class="text-[10px] uppercase font-bold text-slate-400">Jabatan</label><input type="text" id="prof-jabatan" class="w-full border-b py-1 focus:outline-none focus:border-blue-500 text-sm font-medium"></div>
                    <div><label class="text-[10px] uppercase font-bold text-slate-400">Jenis Kelamin</label><select id="prof-jk" class="w-full border-b py-1 focus:outline-none focus:border-blue-500 text-sm font-medium bg-transparent"><option value="">- Pilih -</option><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select></div>
                    <div><label class="text-[10px] uppercase font-bold text-slate-400">Tempat Lahir</label><input type="text" id="prof-tempat-lahir" class="w-full border-b py-1 focus:outline-none focus:border-blue-500 text-sm font-medium"></div>
                    <div><label class="text-[10px] uppercase font-bold text-slate-400">Tanggal Lahir</label><input type="date" id="prof-tgl-lahir" class="w-full border-b py-1 focus:outline-none focus:border-blue-500 text-sm font-medium"></div>
                    <div><label class="text-[10px] uppercase font-bold text-slate-400">Alamat Lengkap</label><textarea id="prof-alamat" rows="2" class="w-full border-b py-1 focus:outline-none focus:border-blue-500 text-sm font-medium"></textarea></div>
                </div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                <h2 class="font-bold text-emerald-600 mb-4 flex items-center gap-2"><i class="ph ph-briefcase text-xl"></i> Data Kepegawaian</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div><label class="text-[10px] uppercase font-bold text-slate-400">NIP / NIY</label><input type="text" id="prof-nip" class="w-full border-b py-1 focus:outline-none focus:border-blue-500 text-sm font-medium"></div>
                    <div><label class="text-[10px] uppercase font-bold text-slate-400">NBM (Muhammadiyah)</label><input type="text" id="prof-nbm" class="w-full border-b py-1 focus:outline-none focus:border-blue-500 text-sm font-medium"></div>
                    <div><label class="text-[10px] uppercase font-bold text-slate-400">Nomor KTP (NIK)</label><input type="number" id="prof-nik" class="w-full border-b py-1 focus:outline-none focus:border-blue-500 text-sm font-medium"></div>
                    <div><label class="text-[10px] uppercase font-bold text-slate-400">NPWP</label><input type="text" id="prof-npwp" class="w-full border-b py-1 focus:outline-none focus:border-blue-500 text-sm font-medium"></div>
                </div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                <h2 class="font-bold text-orange-600 mb-4 flex items-center gap-2"><i class="ph ph-address-book text-xl"></i> Kontak & Rekening</h2>
                <div class="grid grid-cols-1 gap-4">
                    <div><label class="text-[10px] uppercase font-bold text-slate-400">Email</label><input type="email" id="prof-email" class="w-full border-b py-1 text-sm font-medium text-slate-500 bg-slate-50" readonly></div>
                    <div><label class="text-[10px] uppercase font-bold text-slate-400">Nomor HP / WA</label><input type="tel" id="prof-hp" class="w-full border-b py-1 focus:outline-none focus:border-blue-500 text-sm font-medium"></div>
                    <div><label class="text-[10px] uppercase font-bold text-slate-400">Nomor Rekening Bank</label><input type="text" id="prof-rek" class="w-full border-b py-1 focus:outline-none focus:border-blue-500 text-sm font-medium" placeholder="Nama Bank - No Rekening"></div>
                </div>
            </div>
            <button onclick="saveProfile()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg active:scale-95 transition">SIMPAN PERUBAHAN</button>
        </div>
    </section>

    <div id="password-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-slide-up">
            <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-lg text-slate-800 flex items-center gap-2"><i class="ph ph-shield-check text-blue-600 text-2xl"></i> Ganti Password</h3><button onclick="closePasswordModal()" class="text-slate-400 hover:text-red-500"><i class="ph ph-x text-xl"></i></button></div>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Password Lama</label><input type="password" id="pass-old" placeholder="Masukkan password saat ini" class="w-full px-4 py-3 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-slate-50"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">Password Baru</label><input type="password" id="pass-new" placeholder="Minimal 6 karakter" class="w-full px-4 py-3 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-slate-50"></div>
                <div class="pt-2"><button onclick="changePassword()" class="w-full bg-slate-800 text-white font-bold py-3 rounded-lg hover:bg-slate-900 shadow-lg">Update Password</button></div>
            </div>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:w-[500px] rounded-t-2xl sm:rounded-2xl p-5 max-h-[85vh] flex flex-col animate-slide-up shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2"><div><h3 class="font-bold text-lg text-slate-800" id="hist-title">Riwayat</h3><p class="text-[10px] text-slate-400">Rekapitulasi data bulanan</p></div><button onclick="closeHistory()" class="text-slate-400 hover:text-red-500 bg-gray-100 p-2 rounded-full transition"><i class="ph ph-x text-xl"></i></button></div>
            <div class="flex gap-2 mb-4 bg-gray-50 p-2 rounded-lg border border-gray-100">
                <input type="date" id="hist-start" class="w-full border rounded p-1 text-xs bg-white focus:ring-1 focus:ring-blue-500"><span class="text-gray-400 self-center">-</span><input type="date" id="hist-end" class="w-full border rounded p-1 text-xs bg-white focus:ring-1 focus:ring-blue-500">
                <button onclick="loadHistory()" class="bg-blue-600 text-white px-3 rounded text-xs font-bold shadow hover:bg-blue-700 transition"><i class="ph ph-magnifying-glass"></i></button>
            </div>
            <div class="mb-4 bg-blue-50 border border-blue-100 p-3 rounded-xl flex items-center justify-between">
                <div><p class="text-[10px] uppercase font-bold text-blue-400" id="rekap-label">Total</p><p class="text-lg font-bold text-blue-800 leading-none mt-1" id="rekap-total-waktu">-</p></div>
                <div class="text-right"><p class="text-[10px] uppercase font-bold text-blue-400">Frekuensi</p><p class="text-lg font-bold text-blue-800 leading-none mt-1"><span id="rekap-count">0</span>x</p></div>
            </div>
            <div class="overflow-y-auto flex-1 border rounded-lg"><table class="w-full text-xs text-left"><thead class="bg-gray-100 text-gray-600 font-bold sticky top-0"><tr><th class="p-3">Tanggal</th><th class="p-3">Jam Absen</th><th class="p-3 text-right">Status</th></tr></thead><tbody id="history-list" class="divide-y divide-gray-50"></tbody></table></div>
        </div>
    </div>

    <div id="camera-modal" class="fixed inset-0 bg-black z-50 hidden flex flex-col">
        <div class="relative flex-1 bg-black flex justify-center items-center overflow-hidden"><video id="video-feed" autoplay playsinline class="absolute w-full h-full object-cover"></video><canvas id="canvas-capture" class="hidden"></canvas><div class="absolute w-64 h-64 border-2 border-white/50 rounded-full animate-pulse"></div><p class="absolute bottom-10 text-white text-sm bg-black/50 px-3 py-1 rounded-full">Posisikan wajah di dalam lingkaran</p></div>
        <div class="bg-slate-900 p-6 flex justify-between items-center safe-area-bottom"><button onclick="closeCamera()" class="text-white hover:text-red-400 transition">Batal</button><button onclick="captureAndSend()" class="w-16 h-16 bg-white rounded-full border-4 border-slate-500 active:scale-90 transition hover:border-slate-300"></button><div class="w-8"></div></div>
    </div>
    <div id="loader" class="fixed inset-0 bg-black/80 z-[60] hidden flex flex-col justify-center items-center text-white backdrop-blur-sm"><div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-2"></div><p id="loader-text" class="font-medium">Loading...</p></div>

    <script>
        const API_URL = 'https://presensi-sekolah.presensi-muhjitos.workers.dev/'; 
        const ALLOWED_LOCATIONS = [{ lat: -7.554048413753806, lng: 110.74561465185563 }, { lat: -7.716264089358359, lng: 110.58996812548884 }];
        const MAX_RADIUS = 750;

        let currentUser = null; let currentType = ''; let videoStream = null; 
        let currentDist = 9999; let isGpsLocked = false; 
        let globalStats = { sudah_masuk: false, sudah_pulang: false }; let currentHistoryType = '';

        window.onload = () => {
            const saved = localStorage.getItem('user_session');
            if(saved) {
                const session = JSON.parse(saved); currentUser = session.user;
                renderDashboard(session.user, session.stats);
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                document.getElementById('page-dashboard').classList.remove('hidden');
                refreshData(session.user.email); 
            } else { document.getElementById('page-dashboard').classList.add('hidden'); }
            setInterval(updateClock, 1000); checkSchedule(); setInterval(checkSchedule, 60000); watchLocation();
        };

        function switchPage(id) { document.querySelectorAll('section').forEach(el => el.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        function setLoading(show, txt) { const el = document.getElementById('loader'); if(show) { document.getElementById('loader-text').innerText = txt; el.classList.remove('hidden'); } else el.classList.add('hidden'); }

        // --- PANDUAN LOGIC ---
        function openInstallGuide() { document.getElementById('install-modal').classList.remove('hidden'); }

        // --- PROFIL LOGIC ---
        function openProfile() {
            switchPage('page-profile');
            document.getElementById('prof-nama').value = currentUser.nama || '';
            document.getElementById('prof-jabatan').value = currentUser.jabatan || '';
            document.getElementById('prof-email').value = currentUser.email || '';
            document.getElementById('prof-jk').value = currentUser.jenis_kelamin || '';
            document.getElementById('prof-alamat').value = currentUser.alamat || '';
            document.getElementById('prof-tempat-lahir').value = currentUser.tempat_lahir || '';
            document.getElementById('prof-tgl-lahir').value = currentUser.tanggal_lahir || '';
            document.getElementById('prof-nip').value = currentUser.nip || '';
            document.getElementById('prof-nbm').value = currentUser.nbm || '';
            document.getElementById('prof-nik').value = currentUser.nik || '';
            document.getElementById('prof-npwp').value = currentUser.npwp || '';
            document.getElementById('prof-hp').value = currentUser.no_hp || '';
            document.getElementById('prof-rek').value = currentUser.no_rekening || '';
        }
        function saveProfile() {
            const data = { action: 'update_profile', email: currentUser.email, nama: document.getElementById('prof-nama').value, jabatan: document.getElementById('prof-jabatan').value, jenis_kelamin: document.getElementById('prof-jk').value, alamat: document.getElementById('prof-alamat').value, tempat_lahir: document.getElementById('prof-tempat-lahir').value, tanggal_lahir: document.getElementById('prof-tgl-lahir').value, nip: document.getElementById('prof-nip').value, nbm: document.getElementById('prof-nbm').value, nik: document.getElementById('prof-nik').value, npwp: document.getElementById('prof-npwp').value, no_hp: document.getElementById('prof-hp').value, no_rekening: document.getElementById('prof-rek').value };
            setLoading(true, "Menyimpan Profil...");
            fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }).then(r => r.json()).then(res => { setLoading(false); if(res.status === 'success') { alert('Profil Berhasil Diupdate!'); currentUser = res.data; const sess = JSON.parse(localStorage.getItem('user_session')); sess.user = currentUser; localStorage.setItem('user_session', JSON.stringify(sess)); renderDashboard(currentUser, sess.stats); } else { alert(res.message); } }).catch(e => { setLoading(false); alert('Gagal koneksi'); });
        }

        // --- PASSWORD LOGIC ---
        function openPasswordModal() { document.getElementById('password-modal').classList.remove('hidden'); }
        function closePasswordModal() { document.getElementById('password-modal').classList.add('hidden'); document.getElementById('pass-old').value=''; document.getElementById('pass-new').value=''; }
        function changePassword() {
            const oldP = document.getElementById('pass-old').value; const newP = document.getElementById('pass-new').value;
            if(!oldP || !newP) return alert('Isi password lama dan baru!'); if(newP.length < 6) return alert('Password baru minimal 6 karakter');
            setLoading(true, "Mengganti Password...");
            fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'change_password', email: currentUser.email, oldPassword: oldP, newPassword: newP }) }).then(r => r.json()).then(res => { setLoading(false); if(res.status === 'success') { alert('Berhasil Ganti Password! Silakan Login Ulang.'); localStorage.removeItem('user_session'); location.reload(); } else { alert(res.message); } }).catch(e => { setLoading(false); alert('Gagal koneksi'); });
        }

        // --- DASHBOARD LOGIC ---
        function renderDashboard(user, stats) {
            globalStats = stats;
            document.getElementById('dash-nama').innerText = user.nama; document.getElementById('dash-jabatan').innerText = user.jabatan;
            const boxMasuk = document.getElementById('box-masuk-val');
            if (stats.sudah_masuk) {
                const jamM = parseInt(stats.jam_masuk.split(':')[0]); const mntM = parseInt(stats.jam_masuk.split(':')[1]); const selisih = (jamM * 60 + mntM) - (7 * 60);
                if (selisih > 0) boxMasuk.innerHTML = `<span class="text-red-500 font-bold">Telat ${formatDurationShort(selisih)}</span>`; else if (selisih < 0) boxMasuk.innerHTML = `<span class="text-green-600 font-bold">Awal ${formatDurationShort(Math.abs(selisih))}</span>`; else boxMasuk.innerHTML = `<span class="text-green-600 font-bold">Tepat Waktu</span>`;
                document.getElementById('info-masuk').classList.remove('hidden'); document.getElementById('jam-absen-masuk').innerText = stats.jam_masuk; document.getElementById('btn-masuk').innerHTML = `<i class="ph ph-check-circle text-lg"></i> Sudah Masuk`; document.getElementById('btn-masuk').disabled = true; document.getElementById('btn-masuk').classList.add('btn-disabled');
            } else { boxMasuk.innerHTML = `<span class="text-slate-400 text-xs">Belum Absen</span>`; document.getElementById('info-masuk').classList.add('hidden'); document.getElementById('btn-masuk').innerHTML = `<i class="ph ph-camera text-lg"></i> Absen Masuk`; }
            const boxPulang = document.getElementById('box-pulang-val');
            if (stats.sudah_pulang) {
                const jamP = parseInt(stats.jam_pulang.split(':')[0]); const mntP = parseInt(stats.jam_pulang.split(':')[1]); const selisih = (14 * 60) - (jamP * 60 + mntP);
                if (selisih > 0) boxPulang.innerHTML = `<span class="text-orange-500 font-bold">Awal ${formatDurationShort(selisih)}</span>`; else boxPulang.innerHTML = `<span class="text-blue-600 font-bold">Tepat ${Math.abs(selisih) > 0 ? '(+' + formatDurationShort(Math.abs(selisih)) + ')' : ''}</span>`;
            } else { boxPulang.innerHTML = `<span class="text-slate-400 text-xs">Belum Pulang</span>`; }
            if(isGpsLocked) checkSchedule();
        }

        // --- LOCATION, LOGIN, REGISTER, HISTORY (SAMA) ---
        function watchLocation() { if(navigator.geolocation) { navigator.geolocation.watchPosition(pos => { const lat = pos.coords.latitude; const lng = pos.coords.longitude; let minDistance = Infinity; ALLOWED_LOCATIONS.forEach(loc => { const d = getDistance(lat, lng, loc.lat, loc.lng); if(d < minDistance) minDistance = d; }); currentDist = minDistance; isGpsLocked = true; const container = document.getElementById('loc-container'); const icon = document.getElementById('loc-icon'); const status = document.getElementById('loc-status'); if(currentDist > MAX_RADIUS) { status.innerText = `Luar Area (${Math.round(currentDist)}m)`; container.className = "flex items-center gap-2 text-xs bg-red-600/80 text-white p-2 rounded-lg inline-flex backdrop-blur-sm border border-red-400 shadow-md transition-colors duration-300"; icon.className = "ph ph-warning-circle text-white animate-pulse"; } else { status.innerText = `Dalam Area (${Math.round(currentDist)}m)`; container.className = "flex items-center gap-2 text-xs bg-blue-700/50 p-2 rounded-lg inline-flex backdrop-blur-sm border border-blue-500/30 transition-colors duration-300"; icon.className = "ph ph-map-pin text-yellow-300"; } checkSchedule(); }, err => { handleGpsError(); }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }); } else { handleGpsError(); } }
        function handleGpsError() { isGpsLocked = false; const container = document.getElementById('loc-container'); const icon = document.getElementById('loc-icon'); const status = document.getElementById('loc-status'); status.innerText = "GPS Mati / Ditolak"; container.className = "flex items-center gap-2 text-xs bg-red-600 text-white p-2 rounded-lg inline-flex shadow-lg animate-pulse"; icon.className = "ph ph-x-circle text-white"; disableButtons("⚠️ Aktifkan GPS"); }
        function disableButtons(msg) { const btnMasuk = document.getElementById('btn-masuk'); const btnPulang = document.getElementById('btn-pulang'); const styleDisabled = "w-full bg-slate-300 text-slate-500 p-3 rounded-lg font-bold shadow flex justify-center items-center gap-2 cursor-not-allowed"; if(!globalStats.sudah_masuk) { btnMasuk.className = styleDisabled; btnMasuk.disabled = true; btnMasuk.innerHTML = `<i class="ph ph-warning"></i> ${msg}`; } btnPulang.className = styleDisabled; btnPulang.disabled = true; btnPulang.innerHTML = `<i class="ph ph-warning"></i> ${msg}`; }
        function checkSchedule() { if(!isGpsLocked) return; const now = new Date(); const hour = now.getHours(); const day = now.getDay(); const btnMasuk = document.getElementById('btn-masuk'); const btnPulang = document.getElementById('btn-pulang'); if(!btnMasuk || !btnPulang) return; let isClosed = false; let msg = ""; if (day === 0) { isClosed = true; msg = "LIBUR (MINGGU)"; } else if (hour < 6 || hour >= 18) { isClosed = true; msg = "TUTUP (06:00-18:00)"; } if (isClosed) { const styleClosed = "w-full bg-slate-400 text-white p-3 rounded-lg font-bold shadow flex justify-center items-center gap-2 cursor-not-allowed"; btnMasuk.disabled = true; btnMasuk.innerText = msg; btnMasuk.className = styleClosed; btnPulang.disabled = true; btnPulang.innerText = msg; btnPulang.className = styleClosed; } else { updateButtonState(); } }
        function updateButtonState() { const btnMasuk = document.getElementById('btn-masuk'); const btnPulang = document.getElementById('btn-pulang'); const styleActiveMasuk = "w-full bg-emerald-500 hover:bg-emerald-600 text-white p-3 rounded-lg font-bold shadow transition flex justify-center items-center gap-2"; const styleActivePulang = "w-full bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-lg font-bold shadow transition flex justify-center items-center gap-2"; const styleDisabled = "w-full bg-slate-300 text-slate-500 p-3 rounded-lg font-bold shadow flex justify-center items-center gap-2 cursor-not-allowed"; if(currentDist > MAX_RADIUS) { if(!globalStats.sudah_masuk) { btnMasuk.className = styleDisabled; btnMasuk.disabled = true; btnMasuk.innerText = "Lokasi Kejauhan"; } btnPulang.className = styleDisabled; btnPulang.disabled = true; btnPulang.innerText = "Lokasi Kejauhan"; return; } if(!globalStats.sudah_masuk) { btnMasuk.className = styleActiveMasuk; btnMasuk.disabled = false; btnMasuk.innerHTML = `<i class="ph ph-camera text-lg"></i> Absen Masuk`; } btnPulang.className = styleActivePulang; btnPulang.disabled = false; btnPulang.innerHTML = `<i class="ph ph-camera text-lg"></i> Absen Pulang`; }
        function refreshData(email) { fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'refresh_data', email: email }) }).then(r=>r.json()).then(res=>{ if(res.status==='success'){ const sess = JSON.parse(localStorage.getItem('user_session')); sess.stats = res.stats; sess.user = res.user; localStorage.setItem('user_session', JSON.stringify(sess)); currentUser = res.user; renderDashboard(currentUser, res.stats); } }).catch(e=>console.log('Refresh failed')); }
        function captureAndSend() { const v=document.getElementById('video-feed'); const c=document.getElementById('canvas-capture'); c.width=v.videoWidth; c.height=v.videoHeight; const ctx=c.getContext('2d'); ctx.translate(c.width, 0); ctx.scale(-1, 1); ctx.drawImage(v,0,0); const foto=c.toDataURL('image/jpeg',0.5); closeCamera(); setLoading(true, "Mengirim Presensi..."); navigator.geolocation.getCurrentPosition(pos=>{ fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'absen', nama:currentUser.nama, email:currentUser.email, jenis:currentType, lat:pos.coords.latitude, long:pos.coords.longitude, foto:foto}) }).then(r=>r.json()).then(res=>{ setLoading(false); if(res.status==='success') { alert('Berhasil!'); refreshData(currentUser.email); } else alert(res.message); }).catch(e=>{setLoading(false); alert('Gagal kirim');}); }); }
        function doLogin() { const email = document.getElementById('login-email').value; const pass = document.getElementById('login-pass').value; setLoading(true, "Sedang Masuk..."); fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'login', email: email, password: pass }) }).then(r=>r.json()).then(res=>{ setLoading(false); if(res.status==='success'){ currentUser=res.data; localStorage.setItem('user_session', JSON.stringify({user:res.data, stats:res.stats})); renderDashboard(res.data, res.stats); switchPage('page-dashboard'); } else alert(res.message); }).catch(e=>{setLoading(false);alert('Gagal koneksi');}); }
        function doRegister() { const data = { action: 'register', nama: document.getElementById('reg-nama').value, jabatan: document.getElementById('reg-jabatan').value, email: document.getElementById('reg-email').value, password: document.getElementById('reg-pass').value }; setLoading(true, "Mendaftar..."); fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }).then(res => res.json()).then(res => { setLoading(false); if(res.status === 'success') { alert('Berhasil daftar!'); switchPage('page-login'); } else { alert(res.message); } }).catch(e => {setLoading(false); alert('Gagal daftar');}); }
        function doLogout() { if(confirm('Keluar?')) { localStorage.removeItem('user_session'); location.reload(); } }
        async function openCamera(type) { if(type==='MASUK' && globalStats.sudah_masuk) return; if(currentDist > MAX_RADIUS) { alert('Kejauhan!'); return; } currentType=type; document.getElementById('camera-modal').classList.remove('hidden'); try { videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }); document.getElementById('video-feed').srcObject = videoStream; } catch(e){alert('Kamera error');closeCamera();} }
        function closeCamera() { document.getElementById('camera-modal').classList.add('hidden'); if(videoStream) videoStream.getTracks().forEach(t=>t.stop()); }
        function updateClock() { const now = new Date(); document.getElementById('dash-clock').innerText = now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}); document.getElementById('dash-date').innerText = now.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'}); }
        function formatDurationFull(minutes) { if (!minutes || minutes <= 0) return "0 Menit"; const days = Math.floor(minutes / 1440); minutes %= 1440; const hours = Math.floor(minutes / 60); const mins = minutes % 60; let result = ""; if (days > 0) result += `${days} Hari `; if (hours > 0) result += `${hours} Jam `; if (mins > 0) result += `${mins} Menit`; return result.trim(); }
        function formatDurationShort(minutes) { if (!minutes || minutes <= 0) return "0 Mnt"; const h = Math.floor(minutes / 60); const m = minutes % 60; if (h > 0) return `${h} Jam ${m} Mnt`; return `${m} Mnt`; }
        function getDistance(lat1, lon1, lat2, lon2) { const R = 6371e3; const φ1 = lat1 * Math.PI/180; const φ2 = lat2 * Math.PI/180; const Δφ = (lat2-lat1) * Math.PI/180; const Δλ = (lon2-lon1) * Math.PI/180; const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
        function openHistory(type) { currentHistoryType = type; document.getElementById('history-modal').classList.remove('hidden'); document.getElementById('hist-title').innerText = type === 'MASUK' ? 'Detail Masuk' : 'Detail Pulang'; document.getElementById('rekap-label').innerText = type === 'MASUK' ? 'Total Keterlambatan' : 'Total Pulang Awal'; const now = new Date(); const year = now.getFullYear(); const month = String(now.getMonth() + 1).padStart(2, '0'); document.getElementById('hist-start').value = `${year}-${month}-01`; document.getElementById('hist-end').value = `${year}-${month}-${String(new Date(year, now.getMonth()+1, 0).getDate()).padStart(2,'0')}`; loadHistory(); }
        function closeHistory() { document.getElementById('history-modal').classList.add('hidden'); }
        async function loadHistory() { const tbody = document.getElementById('history-list'); tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">Loading...</td></tr>'; document.getElementById('rekap-total-waktu').innerText = "..."; document.getElementById('rekap-count').innerText = "0"; try { const res = await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'get_history', email: currentUser.email, startDate: document.getElementById('hist-start').value, endDate: document.getElementById('hist-end').value, jenis: currentHistoryType }) }); const json = await res.json(); tbody.innerHTML = ''; if (json.data.length === 0) { tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400">Tidak ada data</td></tr>'; document.getElementById('rekap-total-waktu').innerText = "0 Menit"; return; } let totalMenitMasalah = 0; let countMasalah = 0; json.data.forEach(row => { const d = new Date(row.timestamp); const tgl = d.toLocaleDateString('id-ID', {day:'numeric', month:'short', year: '2-digit'}); const jam = d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}); let statusHTML = ""; let isTrouble = false; if (currentHistoryType === 'MASUK') { if (row.status_waktu === 'TERLAMBAT') { statusHTML = `<span class="text-red-500 font-bold">Telat ${formatDurationShort(row.menit_selisih)}</span>`; totalMenitMasalah += row.menit_selisih; isTrouble = true; } else { statusHTML = `<span class="text-green-600 font-bold">Tepat</span>`; } } else { if (row.status_waktu === 'PULANG AWAL') { statusHTML = `<span class="text-orange-500 font-bold">Awal ${formatDurationShort(row.menit_selisih)}</span>`; totalMenitMasalah += row.menit_selisih; isTrouble = true; } else { statusHTML = `<span class="text-blue-600 font-bold">Oke</span>`; } } if(isTrouble) countMasalah++; tbody.innerHTML += `<tr class="hover:bg-gray-50 border-b last:border-0"><td class="p-3 text-gray-600 font-medium">${tgl}</td><td class="p-3 font-bold text-gray-800">${jam}</td><td class="p-3 text-right">${statusHTML}</td></tr>`; }); document.getElementById('rekap-total-waktu').innerText = formatDurationFull(totalMenitMasalah); document.getElementById('rekap-count').innerText = countMasalah; } catch(e) { tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500">Error</td></tr>'; } }
    </script>
</body>
</html>
