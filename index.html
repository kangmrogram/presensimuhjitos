<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E-Presensi Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        video { transform: scaleX(-1); } 
    </style>
</head>
<body class="bg-gray-100 text-slate-800 h-screen overflow-hidden relative">

    <section id="page-login" class="h-full flex flex-col justify-center px-6 bg-white">
        <div class="mb-10">
            <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center mb-4 shadow-lg shadow-blue-200">
                <i class="ph ph-fingerprint text-2xl text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-slate-900">Selamat Datang</h1>
            <p class="text-slate-500 mt-2">Silakan masuk untuk melakukan presensi.</p>
        </div>

        <form onsubmit="event.preventDefault(); doLogin();" class="space-y-5">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                <input type="email" id="login-email" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition" required placeholder="nama@sekolah.sch.id">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                <input type="password" id="login-pass" class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 outline-none transition" required placeholder="••••••">
            </div>
            <button type="submit" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 transition active:scale-95">
                Masuk Aplikasi
            </button>
        </form>
        
        <p class="mt-8 text-center text-sm text-slate-500">
            Belum punya akun? <a href="#" onclick="switchPage('page-register')" class="text-blue-600 font-semibold">Daftar disini</a>
        </p>
    </section>

    <section id="page-register" class="h-full flex flex-col justify-center px-6 bg-white hidden">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-slate-900">Buat Akun Baru</h1>
            <p class="text-slate-500">Isi data diri Anda dengan benar.</p>
        </div>

        <form onsubmit="event.preventDefault(); doRegister();" class="space-y-4">
            <div>
                <label class="block text-xs font-bold uppercase text-slate-400">Nama Lengkap</label>
                <input type="text" id="reg-nama" class="w-full px-4 py-3 rounded-lg bg-slate-50 border-transparent focus:bg-white focus:border-blue-500 border focus:ring-2 focus:ring-blue-100 outline-none transition" required>
            </div>
            <div>
                <label class="block text-xs font-bold uppercase text-slate-400">Jabatan / Mapel</label>
                <input type="text" id="reg-jabatan" class="w-full px-4 py-3 rounded-lg bg-slate-50 border-transparent focus:bg-white focus:border-blue-500 border focus:ring-2 focus:ring-blue-100 outline-none transition" placeholder="Contoh: Guru Matematika" required>
            </div>
            <div>
                <label class="block text-xs font-bold uppercase text-slate-400">Email</label>
                <input type="email" id="reg-email" class="w-full px-4 py-3 rounded-lg bg-slate-50 border-transparent focus:bg-white focus:border-blue-500 border focus:ring-2 focus:ring-blue-100 outline-none transition" required>
            </div>
            <div>
                <label class="block text-xs font-bold uppercase text-slate-400">Password</label>
                <input type="password" id="reg-pass" class="w-full px-4 py-3 rounded-lg bg-slate-50 border-transparent focus:bg-white focus:border-blue-500 border focus:ring-2 focus:ring-blue-100 outline-none transition" required>
            </div>
            <button type="submit" id="btn-reg" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3.5 rounded-xl transition active:scale-95 mt-2">
                Daftar Sekarang
            </button>
        </form>
        
        <p class="mt-6 text-center text-sm text-slate-500">
            Sudah punya akun? <a href="#" onclick="switchPage('page-login')" class="text-blue-600 font-semibold">Login</a>
        </p>
    </section>

    <section id="page-dashboard" class="h-full flex flex-col hidden">
        <div class="bg-white px-6 pt-12 pb-6 rounded-b-[2.5rem] shadow-sm z-10">
            <div class="flex justify-between items-start">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-xl" id="avatar-initial">U</div>
                    <div>
                        <h2 class="font-bold text-lg text-slate-900 leading-tight" id="dash-nama">User Name</h2>
                        <p class="text-xs text-slate-500" id="dash-jabatan">Staff</p>
                    </div>
                </div>
                <button onclick="doLogout()" class="text-slate-400 hover:text-red-500 transition">
                    <i class="ph ph-sign-out text-2xl"></i>
                </button>
            </div>
            
            <div class="mt-6 bg-slate-900 rounded-2xl p-5 text-white shadow-xl shadow-slate-300 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i class="ph ph-calendar-check text-8xl"></i>
                </div>
                <p class="text-slate-400 text-xs mb-1" id="dash-date">Senin, 1 Januari 2025</p>
                <h3 class="text-3xl font-mono font-bold tracking-wider mb-4" id="dash-clock">00:00</h3>
                <div class="flex gap-4">
                    <div>
                        <p class="text-[10px] text-slate-400 uppercase tracking-widest">Masuk</p>
                        <p class="font-semibold text-emerald-400" id="status-masuk">--:--</p>
                    </div>
                    <div class="w-px bg-slate-700"></div>
                    <div>
                        <p class="text-[10px] text-slate-400 uppercase tracking-widest">Pulang</p>
                        <p class="font-semibold text-orange-400" id="status-pulang">--:--</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1 px-6 flex flex-col justify-center gap-4">
            <button onclick="openCamera('MASUK')" class="group relative w-full bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 active:scale-95 transition">
                <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 group-hover:scale-110 transition">
                    <i class="ph ph-arrow-right font-bold text-xl"></i>
                </div>
                <div class="text-left">
                    <h3 class="font-bold text-slate-800">Presensi Masuk</h3>
                    <p class="text-xs text-slate-500">Catat waktu kedatangan Anda</p>
                </div>
            </button>

            <button onclick="openCamera('PULANG')" class="group relative w-full bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 active:scale-95 transition">
                <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 group-hover:scale-110 transition">
                    <i class="ph ph-arrow-left font-bold text-xl"></i>
                </div>
                <div class="text-left">
                    <h3 class="font-bold text-slate-800">Presensi Pulang</h3>
                    <p class="text-xs text-slate-500">Selesaikan pekerjaan hari ini</p>
                </div>
            </button>
        </div>

        <div class="p-6 text-center">
            <p class="text-[10px] text-slate-300">Location Based Attendance System v2.0</p>
        </div>
    </section>

    <div id="camera-modal" class="fixed inset-0 z-50 bg-black hidden flex flex-col">
        <div class="relative flex-1 bg-black overflow-hidden flex justify-center items-center">
            <video id="video-feed" autoplay playsinline class="absolute w-full h-full object-cover"></video>
            <canvas id="canvas-capture" class="hidden"></canvas>
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div class="w-64 h-64 border-2 border-white/30 rounded-full"></div>
            </div>
        </div>
        <div class="bg-slate-900 p-8 flex justify-between items-center">
            <button onclick="closeCamera()" class="text-slate-400 hover:text-white">Batal</button>
            <button onclick="captureAndSend()" class="w-16 h-16 bg-white rounded-full border-4 border-slate-600 active:scale-90 transition flex items-center justify-center">
                <div class="w-14 h-14 bg-white rounded-full border-2 border-black"></div>
            </button>
            <div class="w-8"></div>
        </div>
    </div>

    <div id="loader" class="fixed inset-0 bg-black/80 z-[60] hidden flex flex-col justify-center items-center text-white backdrop-blur-sm">
        <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loader-text" class="text-sm font-medium">Memproses...</p>
    </div>

    <script>
        // CONFIG
        const API_URL = 'https://script.google.com/macros/s/AKfycbzUYPw3r_TT2Gp_szw-MvQpJSJgBnpq6hM1qjXhBOQY0fQTQiMiZFdBY1mC4eOXd0DgbQ/exec'; 

        // STATE
        let currentUser = JSON.parse(localStorage.getItem('user_data')) || null;
        let currentType = '';
        let videoStream = null;

        // INIT
        window.onload = () => {
            if(currentUser) {
                initDashboard();
                switchPage('page-dashboard');
            } else {
                switchPage('page-login');
            }
            setInterval(updateClock, 1000);
        };

        // NAVIGATION
        function switchPage(pageId) {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        }

        // CLOCK
        function updateClock() {
            const now = new Date();
            document.getElementById('dash-clock').innerText = now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('dash-date').innerText = now.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
        }

        // AUTH FUNCTIONS
        function setLoading(show, text='Loading...') {
            const el = document.getElementById('loader');
            const txt = document.getElementById('loader-text');
            if(show) {
                txt.innerText = text;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        function doRegister() {
            setLoading(true, 'Mendaftarkan...');
            const data = {
                action: 'register',
                nama: document.getElementById('reg-nama').value,
                jabatan: document.getElementById('reg-jabatan').value,
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-pass').value
            };

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors', // Penting di GAS
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(() => {
                setLoading(false);
                alert('Pendaftaran berhasil! Silakan Login.');
                switchPage('page-login');
            }).catch(e => {
                setLoading(false);
                alert('Error: ' + e);
            });
        }

        function doLogin() {
            setLoading(true, 'Masuk...');
            const data = {
                action: 'login',
                email: document.getElementById('login-email').value,
                password: document.getElementById('login-pass').value
            };

            // Karena kita butuh response data user, kita gunakan teknik fetch redirect handling atau jsonp.
            // TAPI untuk GAS 'no-cors' kita tidak bisa baca response body.
            // WORKAROUND: Kita asumsikan logic di Client Side sederhana atau gunakan proxy.
            // Untuk solusi gratis & sederhana, kita akan gunakan fetch dengan redirect: 'follow'.
            
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(res => {
                setLoading(false);
                if(res.status === 'success') {
                    currentUser = res.data;
                    localStorage.setItem('user_data', JSON.stringify(currentUser));
                    initDashboard();
                    switchPage('page-dashboard');
                } else {
                    alert(res.message);
                }
            })
            .catch(e => {
                setLoading(false);
                // Fallback debug karena GAS kadang return HTML error
                alert('Gagal login. Pastikan internet lancar atau password benar.');
            });
        }

        function doLogout() {
            if(confirm('Keluar dari aplikasi?')) {
                localStorage.removeItem('user_data');
                currentUser = null;
                switchPage('page-login');
            }
        }

        function initDashboard() {
            document.getElementById('dash-nama').innerText = currentUser.nama;
            document.getElementById('dash-jabatan').innerText = currentUser.jabatan;
            document.getElementById('avatar-initial').innerText = currentUser.nama.charAt(0);
            
            // Load status hari ini dari localstorage (biar cepat)
            const today = new Date().toDateString();
            const lastLog = JSON.parse(localStorage.getItem('last_log') || '{}');
            
            if(lastLog.date === today) {
                if(lastLog.masuk) document.getElementById('status-masuk').innerText = lastLog.masuk;
                if(lastLog.pulang) document.getElementById('status-pulang').innerText = lastLog.pulang;
            } else {
                // Reset display kalo hari baru
                document.getElementById('status-masuk').innerText = "--:--";
                document.getElementById('status-pulang').innerText = "--:--";
            }
        }

        // CAMERA & ABSEN
        async function openCamera(type) {
            currentType = type;
            document.getElementById('camera-modal').classList.remove('hidden');
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                document.getElementById('video-feed').srcObject = videoStream;
            } catch (e) {
                alert('Gagal akses kamera');
                closeCamera();
            }
        }

        function closeCamera() {
            document.getElementById('camera-modal').classList.add('hidden');
            if(videoStream) videoStream.getTracks().forEach(t => t.stop());
        }

        function captureAndSend() {
            const video = document.getElementById('video-feed');
            const canvas = document.getElementById('canvas-capture');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);

            const fotoBase64 = canvas.toDataURL('image/jpeg', 0.5);
            closeCamera();
            setLoading(true, 'Mengirim Lokasi & Foto...');

            if(!navigator.geolocation) {
                alert('Browser tidak dukung GPS');
                setLoading(false);
                return;
            }

            navigator.geolocation.getCurrentPosition(pos => {
                const payload = {
                    action: 'absen',
                    nama: currentUser.nama,
                    email: currentUser.email,
                    jabatan: currentUser.jabatan,
                    jenis: currentType,
                    lat: pos.coords.latitude,
                    long: pos.coords.longitude,
                    foto: fotoBase64
                };

                fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                }).then(() => {
                    setLoading(false);
                    alert(`Absen ${currentType} Berhasil!`);
                    
                    // Simpan log lokal untuk UI
                    const today = new Date().toDateString();
                    const nowTime = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                    let log = JSON.parse(localStorage.getItem('last_log') || '{}');
                    
                    if(log.date !== today) log = { date: today };
                    if(currentType === 'MASUK') log.masuk = nowTime;
                    else log.pulang = nowTime;
                    
                    localStorage.setItem('last_log', JSON.stringify(log));
                    initDashboard();
                    
                }).catch(e => {
                    setLoading(false);
                    alert('Gagal kirim data');
                });
            }, err => {
                setLoading(false);
                alert('Gagal ambil lokasi GPS!');
            });
        }
    </script>
</body>
</html>