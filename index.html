<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presensi SMP Muhammadiyah 1 Kartasura</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        video { transform: scaleX(-1); }
        .btn-disabled { background-color: #cbd5e1 !important; color: #64748b !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden relative">

    <section id="page-login" class="h-full flex flex-col justify-center px-6 bg-white">
        <div class="mb-8 text-center">
            <img src="logo.png" class="h-24 mx-auto mb-4 object-contain" alt="Logo">
            <h1 class="text-2xl font-bold text-blue-900 leading-tight">SMP Muhammadiyah 1<br>Kartasura</h1>
            <p class="text-slate-500 font-medium">Sukoharjo</p>
            <div class="mt-2 w-16 h-1 bg-blue-600 mx-auto rounded-full"></div>
        </div>
        <form onsubmit="event.preventDefault(); doLogin();" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">EMAIL</label>
                <input type="email" id="login-email" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-500 bg-slate-50" placeholder="nama@sekolah.id" required>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">PASSWORD</label>
                <input type="password" id="login-pass" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-500 bg-slate-50" placeholder="******" required>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg active:scale-95 transition hover:bg-blue-700">Masuk Aplikasi</button>
        </form>
        <div class="mt-8 text-center border-t pt-6">
            <p class="text-sm text-slate-400 mb-2">Guru / Karyawan Baru?</p>
            <button onclick="switchPage('page-register')" class="text-blue-600 font-bold text-sm hover:underline flex items-center justify-center gap-1 w-full">Registrasi Akun <i class="ph ph-arrow-right"></i></button>
        </div>
    </section>

    <section id="page-register" class="h-full flex flex-col justify-center px-6 bg-white hidden">
        <div class="mb-6 text-center">
            <img src="logo.png" class="h-12 mx-auto mb-2 opacity-80" alt="Logo Kecil">
            <h1 class="text-xl font-bold text-slate-800">Pendaftaran Akun</h1>
            <p class="text-xs text-slate-500">SMP Muhammadiyah 1 Kartasura</p>
        </div>
        <form onsubmit="event.preventDefault(); doRegister();" class="space-y-3">
            <div><label class="block text-xs font-bold text-slate-500 mb-1">Nama Lengkap & Gelar</label><input type="text" id="reg-nama" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Budi Santoso, S.Pd" required></div>
            <div><label class="block text-xs font-bold text-slate-500 mb-1">Jabatan / Posisi</label><input type="text" id="reg-jabatan" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Guru Matematika" required></div>
            <div><label class="block text-xs font-bold text-slate-500 mb-1">Email Sekolah / Pribadi</label><input type="email" id="reg-email" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-500" placeholder="email@contoh.com" required></div>
            <div><label class="block text-xs font-bold text-slate-500 mb-1">Password</label><input type="password" id="reg-pass" class="w-full px-4 py-3 rounded-lg border focus:ring-2 focus:ring-blue-500" placeholder="Minimal 6 karakter" required></div>
            <button type="submit" class="w-full bg-slate-800 text-white font-bold py-3 rounded-lg mt-4 shadow-lg hover:bg-slate-900">Daftar Sekarang</button>
        </form>
        <div class="mt-6 text-center"><button onclick="switchPage('page-login')" class="text-sm text-blue-600 hover:underline">Kembali ke Login</button></div>
    </section>

    <section id="page-dashboard" class="h-full flex flex-col hidden relative">
        <div class="bg-blue-600 px-6 pt-8 pb-16 rounded-b-[2.5rem] shadow-lg text-white relative z-10">
            <div class="flex items-center gap-3 mb-6 border-b border-blue-500 pb-4">
                <img src="logo.png" class="h-10 w-10 bg-white rounded-full p-1 object-contain shadow-sm" alt="Logo">
                <div><h1 class="font-bold text-white text-sm leading-tight">SMP Muhammadiyah 1</h1><p class="text-blue-200 text-xs">Kartasura, Sukoharjo</p></div>
            </div>
            <div class="flex justify-between items-start mb-6">
                <div><p class="text-xs text-blue-200 mb-1">Selamat Datang,</p><h2 class="font-bold text-lg leading-tight" id="dash-nama">Loading...</h2><span class="text-[10px] bg-blue-700 px-2 py-0.5 rounded text-blue-100 mt-1 inline-block" id="dash-jabatan">...</span></div>
                <button onclick="doLogout()" class="bg-blue-500 p-2 rounded-full hover:bg-blue-400 transition shadow-lg"><i class="ph ph-sign-out text-xl"></i></button>
            </div>
            <div class="flex items-center gap-2 text-xs bg-blue-700/50 p-2 rounded-lg inline-flex backdrop-blur-sm border border-blue-500/30"><i class="ph ph-map-pin text-yellow-300"></i><span id="loc-status">Mencari Lokasi...</span></div>
        </div>

        <div class="px-6 -mt-10 pb-6 flex-1 overflow-y-auto space-y-4 z-20">
            <div class="flex gap-3">
                <div onclick="openHistory('MASUK')" class="flex-1 bg-white p-3 rounded-xl shadow-md border border-slate-100 text-center cursor-pointer active:scale-95 transition hover:bg-blue-50 group">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-1 group-hover:text-blue-500">Info Masuk</p>
                    <div id="box-masuk-val" class="text-sm font-bold text-slate-700">-</div>
                    <p class="text-[10px] text-blue-500 mt-1 underline">Lihat Detail</p>
                </div>
                <div onclick="openHistory('PULANG')" class="flex-1 bg-white p-3 rounded-xl shadow-md border border-slate-100 text-center cursor-pointer active:scale-95 transition hover:bg-blue-50 group">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-1 group-hover:text-blue-500">Info Pulang</p>
                    <div id="box-pulang-val" class="text-sm font-bold text-slate-700">-</div>
                    <p class="text-[10px] text-blue-500 mt-1 underline">Lihat Detail</p>
                </div>
            </div>

            <div class="text-center py-2"><h3 class="text-4xl font-mono font-bold text-slate-700 tracking-tight" id="dash-clock">00:00</h3><p class="text-xs text-slate-400 font-medium" id="dash-date">...</p></div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-2"><span class="font-bold text-slate-700">Presensi Masuk</span><span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">07:00 WIB</span></div>
                <button onclick="openCamera('MASUK')" id="btn-masuk" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white p-3 rounded-lg font-bold shadow flex justify-center items-center gap-2"><i class="ph ph-camera text-lg"></i> Absen Masuk</button>
                <div id="info-masuk" class="hidden mt-2 text-xs text-center text-emerald-600 font-medium">Sudah absen pukul <span id="jam-absen-masuk"></span></div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-2"><span class="font-bold text-slate-700">Presensi Pulang</span><span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">14:00 WIB</span></div>
                <button onclick="openCamera('PULANG')" id="btn-pulang" class="w-full bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-lg font-bold shadow flex justify-center items-center gap-2"><i class="ph ph-camera text-lg"></i> Absen Pulang</button>
            </div>
            <div class="text-center pb-4"><p class="text-[10px] text-slate-300">© SMP Muhammadiyah 1 Kartasura</p></div>
        </div>
    </section>

    <div id="history-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:w-[500px] rounded-t-2xl sm:rounded-2xl p-5 max-h-[85vh] flex flex-col animate-slide-up shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <div><h3 class="font-bold text-lg text-slate-800" id="hist-title">Riwayat</h3><p class="text-[10px] text-slate-400">Rekapitulasi data bulanan</p></div>
                <button onclick="closeHistory()" class="text-slate-400 hover:text-red-500 bg-gray-100 p-2 rounded-full transition"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="flex gap-2 mb-4 bg-gray-50 p-2 rounded-lg border border-gray-100">
                <input type="date" id="hist-start" class="w-full border rounded p-1 text-xs bg-white focus:ring-1 focus:ring-blue-500">
                <span class="text-gray-400 self-center">-</span>
                <input type="date" id="hist-end" class="w-full border rounded p-1 text-xs bg-white focus:ring-1 focus:ring-blue-500">
                <button onclick="loadHistory()" class="bg-blue-600 text-white px-3 rounded text-xs font-bold shadow hover:bg-blue-700 transition"><i class="ph ph-magnifying-glass"></i></button>
            </div>
            <div class="mb-4 bg-blue-50 border border-blue-100 p-3 rounded-xl flex items-center justify-between">
                <div><p class="text-[10px] uppercase font-bold text-blue-400" id="rekap-label">Total</p><p class="text-lg font-bold text-blue-800 leading-none mt-1" id="rekap-total-waktu">-</p></div>
                <div class="text-right"><p class="text-[10px] uppercase font-bold text-blue-400">Frekuensi</p><p class="text-lg font-bold text-blue-800 leading-none mt-1"><span id="rekap-count">0</span>x</p></div>
            </div>
            <div class="overflow-y-auto flex-1 border rounded-lg"><table class="w-full text-xs text-left"><thead class="bg-gray-100 text-gray-600 font-bold sticky top-0"><tr><th class="p-3">Tanggal</th><th class="p-3">Jam Absen</th><th class="p-3 text-right">Status</th></tr></thead><tbody id="history-list" class="divide-y divide-gray-50"></tbody></table></div>
        </div>
    </div>

    <div id="camera-modal" class="fixed inset-0 bg-black z-50 hidden flex flex-col">
        <div class="relative flex-1 bg-black flex justify-center items-center overflow-hidden">
            <video id="video-feed" autoplay playsinline class="absolute w-full h-full object-cover"></video><canvas id="canvas-capture" class="hidden"></canvas>
            <div class="absolute w-64 h-64 border-2 border-white/50 rounded-full animate-pulse"></div><p class="absolute bottom-10 text-white text-sm bg-black/50 px-3 py-1 rounded-full">Posisikan wajah di dalam lingkaran</p>
        </div>
        <div class="bg-slate-900 p-6 flex justify-between items-center safe-area-bottom"><button onclick="closeCamera()" class="text-white hover:text-red-400 transition">Batal</button><button onclick="captureAndSend()" class="w-16 h-16 bg-white rounded-full border-4 border-slate-500 active:scale-90 transition hover:border-slate-300"></button><div class="w-8"></div></div>
    </div>
    <div id="loader" class="fixed inset-0 bg-black/80 z-[60] hidden flex flex-col justify-center items-center text-white backdrop-blur-sm"><div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-2"></div><p id="loader-text" class="font-medium">Loading...</p></div>

    <script>
        const API_URL = 'https://presensi-sekolah.presensi-muhjitos.workers.dev/'; 
        const ALLOWED_LOCATIONS = [{ lat: -7.554048413753806, lng: 110.74561465185563 }, { lat: -7.716264089358359, lng: 110.58996812548884 }];
        const MAX_RADIUS = 750;

        let currentUser = null; let currentType = ''; let videoStream = null; let currentDist = 9999;
        let globalStats = { sudah_masuk: false, sudah_pulang: false }; let currentHistoryType = '';

        window.onload = () => {
            const saved = localStorage.getItem('user_session');
            if(saved) {
                const session = JSON.parse(saved); currentUser = session.user;
                renderDashboard(session.user, session.stats);
                document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
                document.getElementById('page-dashboard').classList.remove('hidden');
                refreshData(session.user.email); 
            } else { document.getElementById('page-dashboard').classList.add('hidden'); }
            setInterval(updateClock, 1000); checkSchedule(); setInterval(checkSchedule, 60000); watchLocation();
        };

        function switchPage(id) { document.querySelectorAll('section').forEach(el => el.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        function setLoading(show, txt) { const el = document.getElementById('loader'); if(show) { document.getElementById('loader-text').innerText = txt; el.classList.remove('hidden'); } else el.classList.add('hidden'); }

        function renderDashboard(user, stats) {
            globalStats = stats;
            document.getElementById('dash-nama').innerText = user.nama; document.getElementById('dash-jabatan').innerText = user.jabatan;

            // Masuk
            const boxMasuk = document.getElementById('box-masuk-val');
            if (stats.sudah_masuk) {
                const jamM = parseInt(stats.jam_masuk.split(':')[0]); const mntM = parseInt(stats.jam_masuk.split(':')[1]);
                const selisih = (jamM * 60 + mntM) - (7 * 60);
                if (selisih > 0) boxMasuk.innerHTML = `<span class="text-red-500 font-bold">Telat ${formatDurationShort(selisih)}</span>`;
                else if (selisih < 0) boxMasuk.innerHTML = `<span class="text-green-600 font-bold">Awal ${formatDurationShort(Math.abs(selisih))}</span>`;
                else boxMasuk.innerHTML = `<span class="text-green-600 font-bold">Tepat Waktu</span>`;
                
                document.getElementById('info-masuk').classList.remove('hidden');
                document.getElementById('jam-absen-masuk').innerText = stats.jam_masuk;
                document.getElementById('btn-masuk').innerText = "Sudah Masuk";
                document.getElementById('btn-masuk').disabled = true;
                document.getElementById('btn-masuk').classList.add('btn-disabled');
            } else {
                boxMasuk.innerHTML = `<span class="text-slate-400 text-xs">Belum Absen</span>`;
                document.getElementById('info-masuk').classList.add('hidden');
                document.getElementById('btn-masuk').innerText = "Absen Masuk";
            }

            // Pulang
            const boxPulang = document.getElementById('box-pulang-val');
            if (stats.sudah_pulang) {
                const jamP = parseInt(stats.jam_pulang.split(':')[0]); const mntP = parseInt(stats.jam_pulang.split(':')[1]);
                const selisih = (14 * 60) - (jamP * 60 + mntP);
                if (selisih > 0) boxPulang.innerHTML = `<span class="text-orange-500 font-bold">Awal ${formatDurationShort(selisih)}</span>`;
                else boxPulang.innerHTML = `<span class="text-blue-600 font-bold">Tepat ${Math.abs(selisih) > 0 ? '(+' + formatDurationShort(Math.abs(selisih)) + ')' : ''}</span>`;
            } else {
                boxPulang.innerHTML = `<span class="text-slate-400 text-xs">Belum Pulang</span>`;
            }
            checkSchedule();
        }

        async function refreshData(email) {
            try {
                const res = await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'refresh_data', email: email }) });
                const json = await res.json();
                if(json.status==='success'){
                    const sess = JSON.parse(localStorage.getItem('user_session')); sess.stats = json.stats;
                    localStorage.setItem('user_session', JSON.stringify(sess));
                    renderDashboard(currentUser, json.stats);
                }
            } catch(e) { console.log('Refresh failed'); }
        }

        function captureAndSend() {
            const v=document.getElementById('video-feed'); const c=document.getElementById('canvas-capture'); c.width=v.videoWidth; c.height=v.videoHeight;
            const ctx=c.getContext('2d'); ctx.translate(c.width, 0); ctx.scale(-1, 1); ctx.drawImage(v,0,0); const foto=c.toDataURL('image/jpeg',0.5); closeCamera();
            setLoading(true, "Mengirim Presensi...");
            navigator.geolocation.getCurrentPosition(pos=>{
                fetch(API_URL,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'absen', nama:currentUser.nama, email:currentUser.email, jenis:currentType, lat:pos.coords.latitude, long:pos.coords.longitude, foto:foto}) })
                .then(r=>r.json()).then(res=>{ 
                    setLoading(false); 
                    if(res.status==='success') { 
                        alert('Berhasil!'); 
                        // REFRESH DATA SETELAH SUKSES
                        refreshData(currentUser.email); 
                    } else alert(res.message); 
                }).catch(e=>{setLoading(false); alert('Gagal kirim');});
            });
        }

        // --- Helper Lainnya (Login, Register, History, Location) sama seperti sebelumnya ---
        function doLogin() {
            const email = document.getElementById('login-email').value; const pass = document.getElementById('login-pass').value; setLoading(true, "Sedang Masuk...");
            fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'login', email: email, password: pass }) })
            .then(r=>r.json()).then(res=>{ setLoading(false); if(res.status==='success'){ currentUser=res.data; localStorage.setItem('user_session', JSON.stringify({user:res.data, stats:res.stats})); renderDashboard(res.data, res.stats); switchPage('page-dashboard'); } else alert(res.message); }).catch(e=>{setLoading(false);alert('Gagal koneksi');});
        }
        function doRegister() {
            const data = { action: 'register', nama: document.getElementById('reg-nama').value, jabatan: document.getElementById('reg-jabatan').value, email: document.getElementById('reg-email').value, password: document.getElementById('reg-pass').value }; setLoading(true, "Mendaftar...");
            fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })
            .then(res => res.json()).then(res => { setLoading(false); if(res.status === 'success') { alert('Berhasil daftar!'); switchPage('page-login'); } else { alert(res.message); } }).catch(e => {setLoading(false); alert('Gagal daftar');});
        }
        function doLogout() { if(confirm('Keluar?')) { localStorage.removeItem('user_session'); location.reload(); } }
        async function openCamera(type) { if(type==='MASUK' && globalStats.sudah_masuk) return; if(currentDist > MAX_RADIUS) { alert('Kejauhan!'); return; } currentType=type; document.getElementById('camera-modal').classList.remove('hidden'); try { videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }); document.getElementById('video-feed').srcObject = videoStream; } catch(e){alert('Kamera error');closeCamera();} }
        function closeCamera() { document.getElementById('camera-modal').classList.add('hidden'); if(videoStream) videoStream.getTracks().forEach(t=>t.stop()); }
        function watchLocation() { if(navigator.geolocation) { navigator.geolocation.watchPosition(pos => { const lat = pos.coords.latitude; const lng = pos.coords.longitude; let minDistance = Infinity; ALLOWED_LOCATIONS.forEach(loc => { const d = getDistance(lat, lng, loc.lat, loc.lng); if(d < minDistance) minDistance = d; }); currentDist = minDistance; const elStatus = document.getElementById('loc-status'); if(currentDist > MAX_RADIUS) { elStatus.innerText = `Luar Area (${Math.round(currentDist)}m)`; elStatus.parentElement.classList.replace('bg-blue-700/50', 'bg-red-600/80'); } else { elStatus.innerText = `Dalam Area (${Math.round(currentDist)}m)`; elStatus.parentElement.classList.replace('bg-red-600/80', 'bg-blue-700/50'); } checkSchedule(); }, err => {}, { enableHighAccuracy: true }); } }
        function updateClock() { const now = new Date(); document.getElementById('dash-clock').innerText = now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}); document.getElementById('dash-date').innerText = now.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'}); }
        function checkSchedule() { const now = new Date(); const hour = now.getHours(); const day = now.getDay(); const btnMasuk = document.getElementById('btn-masuk'); const btnPulang = document.getElementById('btn-pulang'); if(!btnMasuk || !btnPulang) return; let isClosed = false; let msg = ""; if (day === 0) { isClosed = true; msg = "LIBUR (MINGGU)"; } else if (hour < 6 || hour >= 18) { isClosed = true; msg = "TUTUP (06:00-18:00)"; } if (isClosed) { const styleClosed = "w-full bg-slate-400 text-white p-3 rounded-lg font-bold shadow flex justify-center items-center gap-2 cursor-not-allowed"; btnMasuk.disabled = true; btnMasuk.innerText = msg; btnMasuk.className = styleClosed; btnPulang.disabled = true; btnPulang.innerText = msg; btnPulang.className = styleClosed; } else { updateButtonState(); } }
        function updateButtonState() { const btnMasuk = document.getElementById('btn-masuk'); const btnPulang = document.getElementById('btn-pulang'); const styleActiveMasuk = "w-full bg-emerald-500 hover:bg-emerald-600 text-white p-3 rounded-lg font-bold shadow transition flex justify-center items-center gap-2"; const styleActivePulang = "w-full bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-lg font-bold shadow transition flex justify-center items-center gap-2"; const styleDisabled = "w-full bg-slate-300 text-slate-500 p-3 rounded-lg font-bold shadow flex justify-center items-center gap-2 cursor-not-allowed"; if(currentDist > MAX_RADIUS) { if(!globalStats.sudah_masuk) { btnMasuk.className = styleDisabled; btnMasuk.disabled = true; } btnPulang.className = styleDisabled; btnPulang.disabled = true; return; } if(!globalStats.sudah_masuk) { btnMasuk.className = styleActiveMasuk; btnMasuk.disabled = false; btnMasuk.innerText = "Absen Masuk"; } btnPulang.className = styleActivePulang; btnPulang.disabled = false; btnPulang.innerText = "Absen Pulang"; }
        function formatDurationFull(minutes) { if (!minutes || minutes <= 0) return "0 Menit"; const days = Math.floor(minutes / 1440); minutes %= 1440; const hours = Math.floor(minutes / 60); const mins = minutes % 60; let result = ""; if (days > 0) result += `${days} Hari `; if (hours > 0) result += `${hours} Jam `; if (mins > 0) result += `${mins} Menit`; return result.trim(); }
        function formatDurationShort(minutes) { if (!minutes || minutes <= 0) return "0 Mnt"; const h = Math.floor(minutes / 60); const m = minutes % 60; if (h > 0) return `${h} Jam ${m} Mnt`; return `${m} Mnt`; }
        function getDistance(lat1, lon1, lat2, lon2) { const R = 6371e3; const φ1 = lat1 * Math.PI/180; const φ2 = lat2 * Math.PI/180; const Δφ = (lat2-lat1) * Math.PI/180; const Δλ = (lon2-lon1) * Math.PI/180; const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
        
        // --- HISTORY ---
        function openHistory(type) {
            currentHistoryType = type; document.getElementById('history-modal').classList.remove('hidden');
            document.getElementById('hist-title').innerText = type === 'MASUK' ? 'Detail Masuk' : 'Detail Pulang';
            document.getElementById('rekap-label').innerText = type === 'MASUK' ? 'Total Keterlambatan' : 'Total Pulang Awal';
            const now = new Date(); const year = now.getFullYear(); const month = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('hist-start').value = `${year}-${month}-01`;
            document.getElementById('hist-end').value = `${year}-${month}-${String(new Date(year, now.getMonth()+1, 0).getDate()).padStart(2,'0')}`;
            loadHistory();
        }
        function closeHistory() { document.getElementById('history-modal').classList.add('hidden'); }
        async function loadHistory() {
            const tbody = document.getElementById('history-list'); tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center">Loading...</td></tr>';
            document.getElementById('rekap-total-waktu').innerText = "..."; document.getElementById('rekap-count').innerText = "0";
            try {
                const res = await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'get_history', email: currentUser.email, startDate: document.getElementById('hist-start').value, endDate: document.getElementById('hist-end').value, jenis: currentHistoryType }) });
                const json = await res.json(); tbody.innerHTML = '';
                if (json.data.length === 0) { tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400">Tidak ada data</td></tr>'; document.getElementById('rekap-total-waktu').innerText = "0 Menit"; return; }
                let totalMenitMasalah = 0; let countMasalah = 0;
                json.data.forEach(row => {
                    const d = new Date(row.timestamp); const tgl = d.toLocaleDateString('id-ID', {day:'numeric', month:'short', year: '2-digit'}); const jam = d.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                    let statusHTML = ""; let isTrouble = false;
                    if (currentHistoryType === 'MASUK') { if (row.status_waktu === 'TERLAMBAT') { statusHTML = `<span class="text-red-500 font-bold">Telat ${formatDurationShort(row.menit_selisih)}</span>`; totalMenitMasalah += row.menit_selisih; isTrouble = true; } else { statusHTML = `<span class="text-green-600 font-bold">Tepat</span>`; } } 
                    else { if (row.status_waktu === 'PULANG AWAL') { statusHTML = `<span class="text-orange-500 font-bold">Awal ${formatDurationShort(row.menit_selisih)}</span>`; totalMenitMasalah += row.menit_selisih; isTrouble = true; } else { statusHTML = `<span class="text-blue-600 font-bold">Oke</span>`; } }
                    if(isTrouble) countMasalah++;
                    tbody.innerHTML += `<tr class="hover:bg-gray-50 border-b last:border-0"><td class="p-3 text-gray-600 font-medium">${tgl}</td><td class="p-3 font-bold text-gray-800">${jam}</td><td class="p-3 text-right">${statusHTML}</td></tr>`;
                });
                document.getElementById('rekap-total-waktu').innerText = formatDurationFull(totalMenitMasalah); document.getElementById('rekap-count').innerText = countMasalah;
            } catch(e) { tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-red-500">Error</td></tr>'; }
        }
    </script>
</body>
</html>
